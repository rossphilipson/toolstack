#!/bin/bash

function modify_special_vm() {
    local type=`xec-vm -n $1 get type`
    local uuid=`xec-vm -n $1 get uuid`

    if [ $type == "ndvm" ]; then
        db-write /vm/$uuid/policies/modify-vm-settings $2
    elif [ $type == "uivm" ]; then
        db-write /vm/$uuid/policies/modify-vm-settings $2
    fi
}

function reset_extra_xenvm() {
    local value=""
    local substr

    IFS=';' read -r -a subarr <<< "`xec-vm -n $1 get extra-xenvm`"

    for substr in "${subarr[@]}"
    do
        [[ "$substr" =~ "affinity" ]] && continue

        if [ -z "$value" ]; then
            value="$substr"
        else
            value+=";$substr"
        fi
    done

    xec-vm -n $1 set extra-xenvm "$value"
    echo "Reset VM $1 to value: $value"
}

function set_extra_xenvm() {
    local value=`xec-vm -n $1 get extra-xenvm`
    local affinity="node-affinity=$2"

    if [ -z "$value" ]; then
        value="$affinity"
    else
        value+=";$affinity"
    fi

    if [ -n "$3" ]; then
        affinity="stubdom-node-affinity=$2"
        value+=";$affinity"
    fi

    xec-vm -n $1 set extra-xenvm "$value"
    echo "Setting VM $1 to value $value"
}

function numa_setup() {
    local i

    # Disable xenmgr overwrite of uivm/ndvm configs
    db-write /xenmgr/overwrite-ndvm-settings false
    db-write /xenmgr/overwrite-uivm-settings false

    # Process the VM list
    for i in ${VMLIST[@]}; do
        local vm=$(echo $i | cut -d\: -f1)
        local node=$(echo $i | cut -d\: -f2)
        local stub_node=$(echo $i | cut -d\: -f3)
        echo "Setting node affinity for $vm to $node and stubdom to $stub_node"
        # Prepare special VMs to allow modifications
        modify_special_vm $vm true
        # Reset the extra-xenvm node, remove all node-affinity settings
        reset_extra_xenvm $vm
        # Set the new node affinity configuration
        set_extra_xenvm $vm $node $stub_node
        # Reset special VMs to disallow modifications
        modify_special_vm $vm false
    done

    # Setup the new dom0 VCPU configuration, remove previous settings
    echo "Setup dom0 with $DOM0 vcpus"

    if [ $DOM0 -gt 0 ]; then
        [ ! -f /boot/system/grub/grub.orig ] && cp /boot/system/grub/grub.cfg /boot/system/grub/grub.orig

        cat /boot/system/grub/grub.cfg | sed 's/dom0_max_vcpus=[[:digit:]]\+ \?//g' | sed 's/dom0_vcpus_pin \?//g' > /boot/system/grub/tmp.cfg
        cat /boot/system/grub/tmp.cfg | sed "s/XEN_COMMON_CMD=\"/XEN_COMMON_CMD=\"dom0_max_vcpus=$DOM0 dom0_vcpus_pin /" > /boot/system/grub/grub.cfg
    fi
}

function numa_reset() {
    local i

    for i in ${VMLIST[@]}; do
        local vm=$(echo $i | cut -d\: -f1)
        echo "Removing node affinity for $vm"
        # Prepare special VMs to allow modifications
        modify_special_vm $vm true
        # Reset the extra-xenvm node, remove all node-affinity settings
        reset_extra_xenvm $vm
        # Reset special VMs to disallow modifications
        modify_special_vm $vm false
    done

    echo "Removing dom0 node affinity"

    [ ! -f /boot/system/grub/grub.orig ] && cp /boot/system/grub/grub.cfg /boot/system/grub/grub.orig

    cat /boot/system/grub/grub.cfg | sed 's/dom0_max_vcpus=[[:digit:]]\+ \?//g' | sed 's/dom0_vcpus_pin \?//g' > /boot/system/grub/tmp.cfg
    cat /boot/system/grub/tmp.cfg > /boot/system/grub/grub.cfg

    # Enable xenmgr overwrite of uivm/ndvm configs
    db-write /xenmgr/overwrite-ndvm-settings true
    db-write /xenmgr/overwrite-uivm-settings true
}

function numa_display() {
    local i

    for i in ${VMLIST[@]}; do
        local vm=$(echo $i | cut -d\: -f1)
        local value=`xec-vm -n $vm get extra-xenvm`
        echo "$vm extra-xenvm: $value"
    done

    echo ""
    echo "DOM0 cmdline:"
    sed -n '/XEN_COMMON_CMD=/p' /boot/system/grub/grub.cfg
}

function numa_usage() {
    echo "Usage: -s  <config-file> Setup NUMA affinity configuration"
    echo "       -r  <config-file> Reset and remove NUMA affinity configuration"
    echo "       -d  <config-file> Display NUMA affinity configuration"
    echo "       -h  Display this message"
}

getopts "s:r:d:h" OPTION

if [ -n "$OPTARG" ]; then
    . $OPTARG
fi

case $OPTION in
    s)
        numa_setup
        exit
        ;;
    r)
        numa_reset
        exit
        ;;
    d)
        numa_display
        exit
        ;;
    h)  ;&
    *)
        numa_usage
        exit
        ;;
esac

